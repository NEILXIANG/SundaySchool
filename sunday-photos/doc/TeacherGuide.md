# 老师使用指南（打包版 / 不需要安装 Python）

**版本**: v0.4.0  
**更新日期**: 2025-12-28

适用对象：直接双击运行发布包的老师。

本指南以"**最少操作、最少疑惑**"为目标：老师只需要记住一件事——
**把照片放进程序同目录下的 input/ 文件夹，然后再双击运行一次即可。**

如果你只想“照做就行”，请优先看快速开始（更短、更像操作说明）：
- `doc/TeacherQuickStart.md`

---

## 🎯 三步完成照片整理

### 第一步：首次运行（自动创建目录）

**macOS**：
- （推荐）双击 `SundayPhotoOrganizer.app`
- 或双击 `启动工具.sh`

**Windows**：
- 双击 `Launch_SundayPhotoOrganizer.bat`（推荐）
- 或双击 `SundayPhotoOrganizer.exe`

> **macOS安全提示**：第一次运行可能被阻止，解决方法：
> 系统设置 → 隐私与安全性 → 仍要打开

**首次运行会发生什么**：
- 程序会在**可执行文件同目录**创建：`input/`（放照片）、`output/`（结果）、`logs/`（日志）
- 若程序所在位置不可写：会自动改用桌面（或主目录），并在控制台打印 `Work folder:`（以这行显示的路径为准）

---

## 🗂️ 目录结构速查（老师只需记住这 3 个）

你看到的“工作目录（Work folder）”大概长这样：

```
Work folder/
├── input/                     # 你只负责把照片放这里
│   ├── student_photos/         # 学生参考照：一人一个文件夹
│   └── class_photos/           # 课堂/活动照：可以直接放；也可以按日期建子目录
├── output/                    # 你只负责来这里拿整理结果
│   ├── <学生名>/YYYY-MM-DD/    # 每个学生一个文件夹，按日期分类
│   ├── unknown_photos/         # 未归到已知学生（unknown / no-face / error）
│   └── *_整理报告.txt           # 统计与说明（文件名带时间戳）
├── logs/                      # 出问题时发给技术同工（整个文件夹打包）
├── config.json                # （可选）配置文件；一般不需要改
└── doc/                       # 文档（老师指南/快速开始/配置参考）
```

老师记忆口诀：
- **input 放照片 → 运行一次 → output 拿结果；有问题发 logs。**

哪些现象是“正常的”（不用担心）：
- `class_photos/` 里自动出现 `YYYY-MM-DD/` 日期子目录（程序会把根目录照片按日期归档）
- 同一目录下出现同名文件时，照片会自动改名为 `xxx_001.jpg`、`xxx_002.jpg`…（避免覆盖）

什么时候需要求助（把 `logs/` 发给技术同工）：
- 连续两次运行都没有生成 `output/` 或 `*_整理报告.txt`
- 一运行就报错/闪退
- 你确定照片放对了位置，但输出一直为空

### 第二步：放照片

**学生参考照**（必须按这个方式）：
- 放在：`input/student_photos/<学生名>/*.jpg|png...`
- 每个学生一个文件夹；文件名随意
- 示例与截图请看 `doc/TeacherQuickStart.md`

**课堂照片**：
- 位置：`input/class_photos/`
- 建议按日期建子目录：`2025-12-21/group_photo.jpg`
- 也可以直接放在根目录（程序会自动按日期整理）

### 第三步：再次运行

- 再双击运行一次（方式同第一步）
- 程序会开始识别与分类
- 整理完成后，会自动打开 `output/` 文件夹
- 查看结果和整理报告

---

## 📂 输出结果说明

整理完成后，`output/` 文件夹的结构：

```
output/
├── Alice/                      # 每个学生有自己的文件夹
│   ├── 2025-12-21/             # 按日期分类
│   │   ├── group_photo.jpg
│   │   └── game_time.jpg
│   └── 2025-12-28/
│       └── discussion.jpg
├── Bob/
│   └── 2025-12-21/
│       └── group_photo.jpg
├── unknown_photos/             # 未能归到已知学生的照片（详见下方说明）
│   ├── Unknown_Person_1/       # 🆕 相似的未知人脸自动归组（如访客、家长）
│   │   └── 2025-12-21/
│   │       ├── visitor_a.jpg
│   │       └── visitor_b.jpg
│   └── 2025-12-21/             # 单次出现的人脸
│       └── blurry_105632.jpg
└── 20251221_143052_整理报告.txt  # 详细统计报告
```

说明：
- 照片文件名默认保留原名；如果同一目录下出现同名，程序会自动改为 `xxx_001.jpg`、`xxx_002.jpg`… 以避免覆盖。
- `unknown_photos/日期/` 里可能包含：未识别（unknown）、无人脸（no-face）、处理出错（error）三类照片；整理报告会分列统计，避免把“无人脸/出错”误当成“陌生人”。

**新功能（v0.4.0）**：未知人脸智能聚类
- 程序会自动识别相似的未知人脸（如访客、家长、新学生）
- 相似的人脸会归入 `unknown_photos/Unknown_Person_1/`、`Unknown_Person_2/` 等
- 单次出现的人脸仍在 `unknown_photos/日期/` 中
- 这样方便老师：
  - 快速找到某个访客的所有照片
  - 识别经常参与的家长
  - 为新学生补充参考照（看到 Unknown_Person_X 中照片多，可能是新学生）

---

## ⚠️ 重要提示（避免困惑点）

### 照片会被移动吗？

**会！但这是正常的**：
- 程序会把 `class_photos/` 根目录的照片**按日期移动**到 `YYYY-MM-DD/` 子目录
- 这是为了增量处理与便于查找
- 原始照片不会丢失，只是换了位置

**举例**：
```
之前：class_photos/photo1.jpg
之后：class_photos/2025-12-21/photo1.jpg
```

**如果遇到同名怎么办？**
- 如果同一天目录里出现同名文件，程序会自动改名（例如 `photo1.jpg` → `photo1_001.jpg`）再归档，并在控制台/日志里提示。

### 需要每次放照片吗？

**不需要！第二次运行会更快**：
- 程序会记住已经处理过的照片
- 只处理新增或变更的照片
- 这叫"增量处理"，节省时间

---

## 💡 常见问题

### Q1: 程序很快结束，没有输出？
**原因**：通常是 `student_photos/` 或 `class_photos/` 里没照片

**解决**：
1. 检查 `student_photos/` 是否有学生文件夹
2. 检查 `class_photos/` 是否有照片
3. 按提示放好后再运行

### Q2: 识别不准确怎么办？
**不用调参数**！按这三步做就够：

1. **补充参考照**：
   - 给该学生补 2-3 张清晰正脸参考照
   - 要求：清晰、正脸、无遮挡、不要太小

2. **参考照质量**：
   - 尽量"只拍这个学生一个人"
   - 不要用多人合照当参考照

3. **课堂照质量**：
   - 光线充足
   - 人脸不要太小/太模糊
   - 必要时换更清晰的原图

### Q3: 什么是 Unknown_Person_X？
**这是新功能（v0.4.0）**：智能未知人脸聚类

**含义**：
- 程序自动将相似的未知人脸归在一起
- `Unknown_Person_1` = 第1组相似人脸
- `Unknown_Person_2` = 第2组相似人脸

**应用场景**：
- **访客**：家长来访多次，会自动归组
- **新学生**：还没建立参考照，临时归档
- **志愿者**：经常参与活动的志愿者

**如何处理**：
1. 查看 `Unknown_Person_X` 文件夹里的照片
2. 如果是新学生：
   - 选 2-3张清晰照片
   - 放到 `student_photos/<学生名>/` 
   - 下次运行就会识别了
3. 如果是访客/家长：可以保留或删除（看需求）

### Q4: 怎么强制“全量再跑一遍”？
**现象**：感觉有新放入的照片没有被处理。

**最简单的做法**：
- 在课堂照片里，把对应日期文件夹重命名（例如 `2025-12-21` → `2025-12-21-new`），然后再运行一次；程序会当作新照片全量处理。

**更彻底的做法（可选）**：
- 打开 `output/`，删除 `.state/` 目录（增量记录）和同日期下的缓存文件（如果存在），再运行一次。原始照片不会被删除，只会重新识别。

### Q5: 程序运行出错怎么办？
**需要求助时**，请提供：
1. `logs/` 里最新的日志文件（在程序同目录的 logs/ 内；若程序回退到桌面/主目录，请以控制台提示的 Work folder 为准）
2. 描述问题（什么时候出错、错误提示等）

---

## 📊 理解整理报告

打开 `output/` 文件夹里最新的 `*_整理报告.txt`（带时间戳），你会看到：

```
==============================================
主日学照片整理报告
==============================================
整理时间: 2025-12-21 14:30:52

📊 统计信息
--------------
总复制任务数: 25
成功识别: 20 张
未识别: 5 张
处理耗时: 45 秒

分类统计（按原始照片张数）:
未识别（unknown_photos）: 3 张
无人脸（no_face_photos）: 1 张
出错（error_photos）: 1 张

👥 学生分布
--------------
Alice: 12 张
Bob: 8 张
Unknown_Person_1: 3 张  # 🆕 访客/家长/新学生
unknown_photos: 2 张    # 单次出现的人脸

说明：报告里的“复制任务数”按输出结果统计。多人合影如果识别到多名学生，会被复制到多个学生文件夹，因此复制任务数可能大于原始照片张数。

✅ 整理完成
输出目录: .../output/
==============================================
```

---

## 🚀 进阶使用（可选）

### 如果照片很多（30+张）

程序会在满足条件时**自动启用并行加速**（默认开启；小批量会自动回到串行更稳）。

你可以从控制台/日志里看到类似提示：

```
🚀 启用并行识别：photos=80 workers=6 chunk_size=12 min_photos=30
```

如果照片数量较少，会看到：

```
ℹ️  照片数量(15张) < 并行阈值(30张)，使用串行模式（小批量更稳定）
```

**遇到卡顿/低内存机器排障**（打包版/源码版都适用）：
- 强制串行：运行前设置 `SUNDAY_PHOTOS_NO_PARALLEL=1`

### 如果想保留原始照片

**方法**：在整理前先备份
```
复制 class_photos/ → class_photos_backup/
```

然后运行程序整理 `class_photos/`

---

## 🎓 小贴士

1. **参考照越清晰，识别越准确**
   - 推荐：证件照、清晰自拍
   - 避免：模糊、侧脸、多人合照

2. **定期清理 logs/ 文件夹**（可选）
   - 日志会累积，占用空间
   - 可以定期删除旧日志

3. **output/ 可以直接发给家长**
   - 每个学生文件夹独立
   - 可以压缩后发送

4. **Unknown_Person_X 的妙用**
   - 快速找到访客的所有照片
   - 识别"常客"（多次出现的家长）
   - 为新学生建档（转为正式学生）

---

## 开发者备注（非老师使用）

源码/命令行入口与参数（如 `--tolerance`）属于开发与测试用途；老师默认走打包版 `SundayPhotoOrganizer` + 工作目录（Work folder）模式。

如需调整高级参数（如识别阈值、并行配置），请参考：
- 配置参考手册（SSOT）：[CONFIG_REFERENCE.md](CONFIG_REFERENCE.md)
- 开发指南：[DeveloperGuide.md](DeveloperGuide.md)
