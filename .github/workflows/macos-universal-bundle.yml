name: macOS universal bundle (arm64 + x86_64)

on:
  workflow_dispatch:

jobs:
  build_arm64:
    name: Build arm64
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          brew update
          brew install cmake
          cmake --version

      - name: Install dependencies
        working-directory: sunday-photos
        run: |
          export PATH="$(brew --prefix)/bin:$PATH"
          which cmake
          cmake --version

          python -m pip install --upgrade pip setuptools wheel
          python -m pip uninstall -y cmake || true

          # dlib is the riskiest dependency in CI; prefer wheels when available
          python -m pip install "dlib>=19.24.2" --only-binary :all: || python -m pip install "dlib>=19.24.2"
          python -m pip install --prefer-binary -r requirements.txt
          python -m pip install pyinstaller

      - name: Build (arm64)
        working-directory: sunday-photos
        env:
          TARGET_ARCH: arm64
        run: |
          bash scripts/build_mac_app.sh

      - name: Report packaged size (arm64 diagnostics)
        working-directory: sunday-photos
        shell: bash
        run: |
          set -euo pipefail
          echo "release_console size (arm64 build):"
          du -sh release_console || true
          echo "Top 20 largest files:"
          du -ah release_console | sort -hr | head -n 20 || true

      - name: Upload artifact (arm64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-release_console
          path: sunday-photos/release_console/

  build_x86_64:
    name: Build x86_64
    runs-on: macos-15-intel
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          brew update
          brew install cmake
          cmake --version

      - name: Install dependencies
        working-directory: sunday-photos
        run: |
          export PATH="$(brew --prefix)/bin:$PATH"
          which cmake
          cmake --version

          python -m pip install --upgrade pip setuptools wheel
          python -m pip uninstall -y cmake || true

          # dlib is the riskiest dependency in CI; prefer wheels when available
          python -m pip install "dlib>=19.24.2" --only-binary :all: || python -m pip install "dlib>=19.24.2"
          python -m pip install --prefer-binary -r requirements.txt
          python -m pip install pyinstaller

      - name: Build (x86_64)
        working-directory: sunday-photos
        env:
          TARGET_ARCH: x86_64
        run: |
          bash scripts/build_mac_app.sh

      - name: Report packaged size (x86_64 diagnostics)
        working-directory: sunday-photos
        shell: bash
        run: |
          set -euo pipefail
          echo "release_console size (x86_64 build):"
          du -sh release_console || true
          echo "Top 20 largest files:"
          du -ah release_console | sort -hr | head -n 20 || true

      - name: Upload artifact (x86_64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-release_console
          path: sunday-photos/release_console/

  bundle:
    name: Bundle universal package
    runs-on: macos-14
    needs: [build_arm64, build_x86_64]
    steps:
      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-release_console
          path: artifacts/arm64

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-x86_64-release_console
          path: artifacts/x86_64

      - name: Create universal release_console
        shell: bash
        run: |
          set -euo pipefail

          ARM_DIR="artifacts/arm64"
          X86_DIR="artifacts/x86_64"

          if [ ! -f "$ARM_DIR/SundayPhotoOrganizer" ]; then
            echo "arm64 executable not found: $ARM_DIR/SundayPhotoOrganizer" >&2
            ls -la "$ARM_DIR" || true
            exit 1
          fi
          if [ ! -f "$X86_DIR/SundayPhotoOrganizer" ]; then
            echo "x86_64 executable not found: $X86_DIR/SundayPhotoOrganizer" >&2
            ls -la "$X86_DIR" || true
            exit 1
          fi

          rm -rf release_console_universal
          cp -R "$ARM_DIR" release_console_universal

          mkdir -p release_console_universal/bin
          mv release_console_universal/SundayPhotoOrganizer release_console_universal/bin/SundayPhotoOrganizer-arm64
          cp "$X86_DIR/SundayPhotoOrganizer" release_console_universal/bin/SundayPhotoOrganizer-x86_64

          cat > release_console_universal/SundayPhotoOrganizer <<'EOF'
          #!/bin/bash
          set -euo pipefail
          DIR="$(cd "$(dirname "$0")" && pwd)"
          ARCH="$(uname -m)"
          if [[ "$ARCH" == "arm64" ]]; then
            exec "$DIR/bin/SundayPhotoOrganizer-arm64" "$@"
          else
            exec "$DIR/bin/SundayPhotoOrganizer-x86_64" "$@"
          fi
          EOF
          chmod +x release_console_universal/SundayPhotoOrganizer
          chmod +x release_console_universal/bin/SundayPhotoOrganizer-arm64
          chmod +x release_console_universal/bin/SundayPhotoOrganizer-x86_64

          echo "Universal package prepared: release_console_universal"
          ls -la release_console_universal | head -n 50

      - name: Upload artifact (universal)
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: release_console_universal/
