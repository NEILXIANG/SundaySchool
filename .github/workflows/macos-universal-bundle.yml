name: macOS universal bundle (arm64 + x86_64)

on:
  workflow_dispatch:

jobs:
  build_arm64:
    name: Build arm64
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          brew update
          brew install cmake
          cmake --version

      - name: Install dependencies
        working-directory: sunday-photos
        run: |
          export PATH="$(brew --prefix)/bin:$PATH"
          which cmake
          cmake --version

          python -m pip install --upgrade pip setuptools wheel
          python -m pip uninstall -y cmake || true

          # dlib is the riskiest dependency in CI; prefer wheels when available
          python -m pip install "dlib>=19.24.2" --only-binary :all: || python -m pip install "dlib>=19.24.2"
          python -m pip install --prefer-binary -r requirements.txt
          python -m pip install pyinstaller

      - name: Build (arm64)
        working-directory: sunday-photos
        env:
          TARGET_ARCH: arm64
        run: |
          bash scripts/build_mac_app.sh

      - name: Report packaged size (arm64 diagnostics)
        working-directory: sunday-photos
        shell: bash
        run: |
          set -euo pipefail
          echo "release_console size (arm64 build):"
          du -sh release_console || true
          echo "Top 20 largest files:"
          du -ah release_console | sort -hr | head -n 20 || true

      - name: Upload artifact (arm64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-release_console
          path: sunday-photos/release_console/

  build_x86_64:
    name: Build x86_64
    runs-on: macos-15-intel
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          brew update
          brew install cmake
          cmake --version

      - name: Install dependencies
        working-directory: sunday-photos
        run: |
          export PATH="$(brew --prefix)/bin:$PATH"
          which cmake
          cmake --version

          python -m pip install --upgrade pip setuptools wheel
          python -m pip uninstall -y cmake || true

          # dlib is the riskiest dependency in CI; prefer wheels when available
          python -m pip install "dlib>=19.24.2" --only-binary :all: || python -m pip install "dlib>=19.24.2"
          python -m pip install --prefer-binary -r requirements.txt
          python -m pip install pyinstaller

      - name: Build (x86_64)
        working-directory: sunday-photos
        env:
          TARGET_ARCH: x86_64
        run: |
          bash scripts/build_mac_app.sh

      - name: Report packaged size (x86_64 diagnostics)
        working-directory: sunday-photos
        shell: bash
        run: |
          set -euo pipefail
          echo "release_console size (x86_64 build):"
          du -sh release_console || true
          echo "Top 20 largest files:"
          du -ah release_console | sort -hr | head -n 20 || true

      - name: Upload artifact (x86_64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-release_console
          path: sunday-photos/release_console/

  bundle:
    name: Bundle universal package
    runs-on: macos-14
    needs: [build_arm64, build_x86_64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-release_console
          path: artifacts/arm64

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-x86_64-release_console
          path: artifacts/x86_64

      - name: Create universal release_console
        shell: bash
        run: |
          set -euo pipefail

          ARM_DIR="artifacts/arm64"
          X86_DIR="artifacts/x86_64"

          # Validate onedir bundles exist (PyInstaller configured for onedir mode)
          if [ ! -d "$ARM_DIR/SundayPhotoOrganizer" ]; then
            echo "âŒ arm64 onedir bundle not found: $ARM_DIR/SundayPhotoOrganizer/" >&2
            echo "Expected: $ARM_DIR/SundayPhotoOrganizer/SundayPhotoOrganizer (executable)" >&2
            ls -la "$ARM_DIR" || true
            exit 1
          fi
          if [ ! -d "$X86_DIR/SundayPhotoOrganizer" ]; then
            echo "âŒ x86_64 onedir bundle not found: $X86_DIR/SundayPhotoOrganizer/" >&2
            echo "Expected: $X86_DIR/SundayPhotoOrganizer/SundayPhotoOrganizer (executable)" >&2
            ls -la "$X86_DIR" || true
            exit 1
          fi
          
          # Validate executables inside onedir bundles
          if [ ! -f "$ARM_DIR/SundayPhotoOrganizer/SundayPhotoOrganizer" ]; then
            echo "âŒ arm64 executable missing in onedir bundle" >&2
            ls -la "$ARM_DIR/SundayPhotoOrganizer" || true
            exit 1
          fi
          if [ ! -f "$X86_DIR/SundayPhotoOrganizer/SundayPhotoOrganizer" ]; then
            echo "âŒ x86_64 executable missing in onedir bundle" >&2
            ls -la "$X86_DIR/SundayPhotoOrganizer" || true
            exit 1
          fi

          # Create universal bundle structure
          rm -rf release_console_universal
          cp -R "$ARM_DIR" release_console_universal
          
          # Move architecture-specific onedir bundles into bin/
          mkdir -p release_console_universal/bin
          mv release_console_universal/SundayPhotoOrganizer release_console_universal/bin/SundayPhotoOrganizer-arm64
          cp -R "$X86_DIR/SundayPhotoOrganizer" release_console_universal/bin/SundayPhotoOrganizer-x86_64

          # Create universal launcher script
          cat > release_console_universal/SundayPhotoOrganizer <<'EOF'
          #!/bin/bash
          set -euo pipefail
          DIR="$(cd "$(dirname "$0")" && pwd)"
          ARCH="$(uname -m)"
          
          if [[ "$ARCH" == "arm64" ]]; then
            TARGET="$DIR/bin/SundayPhotoOrganizer-arm64"
          else
            TARGET="$DIR/bin/SundayPhotoOrganizer-x86_64"
          fi
          
          # Execute architecture-specific onedir bundle
          exec "$TARGET/SundayPhotoOrganizer" "$@"
          EOF
          chmod +x release_console_universal/SundayPhotoOrganizer

          # Create .command file for double-click launching on macOS
          cat > release_console_universal/å¯åŠ¨å·¥å…·.command <<'EOF'
          #!/bin/bash
          # macOS åŒå‡»å¯åŠ¨è„šæœ¬ï¼ˆ.command æ–‡ä»¶å¯åœ¨ Finder ä¸­åŒå‡»è¿è¡Œï¼‰
          set -euo pipefail
          
          # åˆ‡æ¢åˆ°è„šæœ¬æ‰€åœ¨ç›®å½•
          cd "$(dirname "$0")"
          
          # è°ƒç”¨ä¸»å¯åŠ¨å™¨
          ./SundayPhotoOrganizer
          
          # è¿è¡Œå®Œæˆåæš‚åœï¼Œè®©ç”¨æˆ·çœ‹åˆ°è¾“å‡º
          echo ""
          echo "æŒ‰ä»»æ„é”®é€€å‡º..."
          read -n 1 -s
          EOF
          chmod +x release_console_universal/å¯åŠ¨å·¥å…·.command

          # Set executable permissions on architecture-specific binaries
          chmod +x release_console_universal/bin/SundayPhotoOrganizer-arm64/SundayPhotoOrganizer
          chmod +x release_console_universal/bin/SundayPhotoOrganizer-x86_64/SundayPhotoOrganizer

          echo "âœ… Universal console package prepared: release_console_universal"
          echo "ğŸ“¦ Structure:"
          echo "  - SundayPhotoOrganizer (universal launcher script)"
          echo "  - å¯åŠ¨å·¥å…·.command (double-click launcher for Finder)"
          echo "  - bin/SundayPhotoOrganizer-arm64/ (onedir bundle)"
          echo "  - bin/SundayPhotoOrganizer-x86_64/ (onedir bundle)"
          ls -la release_console_universal | head -n 50

          # Also prepare a repo-local layout compatible with scripts/build_mac_teacher_app.sh:
          #   sunday-photos/release_console/SundayPhotoOrganizer/SundayPhotoOrganizer
          # This keeps CI output consistent with local release bundles and ensures the .app
          # bundle includes first-run cleanup tools and teacher docs.
          rm -rf sunday-photos/release_console
          mkdir -p sunday-photos/release_console/SundayPhotoOrganizer
          cp -R release_console_universal/bin sunday-photos/release_console/SundayPhotoOrganizer/bin
          cp -f release_console_universal/SundayPhotoOrganizer sunday-photos/release_console/SundayPhotoOrganizer/SundayPhotoOrganizer
          chmod +x sunday-photos/release_console/SundayPhotoOrganizer/SundayPhotoOrganizer

      - name: Build macOS teacher bundle (.app + docs + first-run cleanup)
        working-directory: sunday-photos
        shell: bash
        env:
          # CI already prepared release_console/SundayPhotoOrganizer.
          # Avoid triggering a console rebuild inside the teacher bundle script.
          BUNDLE_INSIGHTFACE_MODELS: "0"
        run: |
          set -euo pipefail
          bash scripts/build_mac_teacher_app.sh

          # Keep artifact path stable for workflow consumers.
          rm -rf release_mac_app_universal
          mv release_mac_app release_mac_app_universal

      - name: Upload console bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal-console
          path: release_console_universal/
          retention-days: 7

      - name: Upload .app bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal-app
          path: sunday-photos/release_mac_app_universal/
          retention-days: 7
