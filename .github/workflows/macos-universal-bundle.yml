name: macOS universal bundle (arm64 + x86_64)

on:
  workflow_dispatch:

jobs:
  build_arm64:
    name: Build arm64
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          brew update
          brew install cmake
          cmake --version

      - name: Install dependencies
        working-directory: sunday-photos
        run: |
          export PATH="$(brew --prefix)/bin:$PATH"
          which cmake
          cmake --version

          python -m pip install --upgrade pip setuptools wheel
          python -m pip uninstall -y cmake || true

          # dlib is the riskiest dependency in CI; prefer wheels when available
          python -m pip install "dlib>=19.24.2" --only-binary :all: || python -m pip install "dlib>=19.24.2"
          python -m pip install --prefer-binary -r requirements.txt
          python -m pip install pyinstaller

      - name: Build (arm64)
        working-directory: sunday-photos
        env:
          TARGET_ARCH: arm64
        run: |
          bash scripts/build_mac_app.sh

      - name: Report packaged size (arm64 diagnostics)
        working-directory: sunday-photos
        shell: bash
        run: |
          set -euo pipefail
          echo "release_console size (arm64 build):"
          du -sh release_console || true
          echo "Top 20 largest files:"
          du -ah release_console | sort -hr | head -n 20 || true

      - name: Upload artifact (arm64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-release_console
          path: sunday-photos/release_console/

  build_x86_64:
    name: Build x86_64
    runs-on: macos-15-intel
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          brew update
          brew install cmake
          cmake --version

      - name: Install dependencies
        working-directory: sunday-photos
        run: |
          export PATH="$(brew --prefix)/bin:$PATH"
          which cmake
          cmake --version

          python -m pip install --upgrade pip setuptools wheel
          python -m pip uninstall -y cmake || true

          # dlib is the riskiest dependency in CI; prefer wheels when available
          python -m pip install "dlib>=19.24.2" --only-binary :all: || python -m pip install "dlib>=19.24.2"
          python -m pip install --prefer-binary -r requirements.txt
          python -m pip install pyinstaller

      - name: Build (x86_64)
        working-directory: sunday-photos
        env:
          TARGET_ARCH: x86_64
        run: |
          bash scripts/build_mac_app.sh

      - name: Report packaged size (x86_64 diagnostics)
        working-directory: sunday-photos
        shell: bash
        run: |
          set -euo pipefail
          echo "release_console size (x86_64 build):"
          du -sh release_console || true
          echo "Top 20 largest files:"
          du -ah release_console | sort -hr | head -n 20 || true

      - name: Upload artifact (x86_64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-release_console
          path: sunday-photos/release_console/

  bundle:
    name: Bundle universal package
    runs-on: macos-14
    needs: [build_arm64, build_x86_64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-release_console
          path: artifacts/arm64

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-x86_64-release_console
          path: artifacts/x86_64

      - name: Create universal release_console
        shell: bash
        run: |
          set -euo pipefail

          ARM_DIR="artifacts/arm64"
          X86_DIR="artifacts/x86_64"

          # PyInstaller may produce either:
          # - onefile: SundayPhotoOrganizer (file)
          # - onedir : SundayPhotoOrganizer/ (directory containing the executable)
          if [ ! -e "$ARM_DIR/SundayPhotoOrganizer" ]; then
            echo "arm64 payload not found: $ARM_DIR/SundayPhotoOrganizer" >&2
            ls -la "$ARM_DIR" || true
            exit 1
          fi
          if [ ! -e "$X86_DIR/SundayPhotoOrganizer" ]; then
            echo "x86_64 payload not found: $X86_DIR/SundayPhotoOrganizer" >&2
            ls -la "$X86_DIR" || true
            exit 1
          fi

          rm -rf release_console_universal
          cp -R "$ARM_DIR" release_console_universal

          mkdir -p release_console_universal/bin
          rm -rf release_console_universal/bin/SundayPhotoOrganizer-arm64 release_console_universal/bin/SundayPhotoOrganizer-x86_64

          # Move arm64 payload (file or directory) into bin/
          mv release_console_universal/SundayPhotoOrganizer release_console_universal/bin/SundayPhotoOrganizer-arm64

          # Copy x86_64 payload (file or directory) into bin/
          if [ -d "$X86_DIR/SundayPhotoOrganizer" ]; then
            cp -R "$X86_DIR/SundayPhotoOrganizer" release_console_universal/bin/SundayPhotoOrganizer-x86_64
          else
            cp "$X86_DIR/SundayPhotoOrganizer" release_console_universal/bin/SundayPhotoOrganizer-x86_64
          fi

          # Validate payloads
          if [ -d "release_console_universal/bin/SundayPhotoOrganizer-arm64" ]; then
            test -f "release_console_universal/bin/SundayPhotoOrganizer-arm64/SundayPhotoOrganizer"
          else
            test -f "release_console_universal/bin/SundayPhotoOrganizer-arm64"
          fi
          if [ -d "release_console_universal/bin/SundayPhotoOrganizer-x86_64" ]; then
            test -f "release_console_universal/bin/SundayPhotoOrganizer-x86_64/SundayPhotoOrganizer"
          else
            test -f "release_console_universal/bin/SundayPhotoOrganizer-x86_64"
          fi

          # Create main launcher script (for terminal use)
          cat > release_console_universal/SundayPhotoOrganizer <<'EOF'
          #!/bin/bash
          set -euo pipefail
          DIR="$(cd "$(dirname "$0")" && pwd)"
          ARCH="$(uname -m)"
          if [[ "$ARCH" == "arm64" ]]; then
            TARGET="$DIR/bin/SundayPhotoOrganizer-arm64"
          else
            TARGET="$DIR/bin/SundayPhotoOrganizer-x86_64"
          fi

          if [[ -d "$TARGET" ]]; then
            exec "$TARGET/SundayPhotoOrganizer" "$@"
          else
            exec "$TARGET" "$@"
          fi
          EOF
          chmod +x release_console_universal/SundayPhotoOrganizer

          # Create .command file for double-click launching on macOS
          cat > release_console_universal/启动工具.command <<'EOF'
          #!/bin/bash
          # macOS 双击启动脚本（.command 文件可在 Finder 中双击运行）
          set -euo pipefail
          
          # 切换到脚本所在目录
          cd "$(dirname "$0")"
          
          # 调用主启动器
          ./SundayPhotoOrganizer
          
          # 运行完成后暂停，让用户看到输出
          echo ""
          echo "按任意键退出..."
          read -n 1 -s
          EOF
          chmod +x release_console_universal/启动工具.command

          # Set executable permissions on actual binaries
          if [ -d release_console_universal/bin/SundayPhotoOrganizer-arm64 ]; then
            chmod +x release_console_universal/bin/SundayPhotoOrganizer-arm64/SundayPhotoOrganizer
          else
            chmod +x release_console_universal/bin/SundayPhotoOrganizer-arm64
          fi
          if [ -d release_console_universal/bin/SundayPhotoOrganizer-x86_64 ]; then
            chmod +x release_console_universal/bin/SundayPhotoOrganizer-x86_64/SundayPhotoOrganizer
          else
            chmod +x release_console_universal/bin/SundayPhotoOrganizer-x86_64
          fi

          echo "Universal console package prepared: release_console_universal"
          echo "- Main launcher: SundayPhotoOrganizer (for terminal)"
          echo "- Double-click launcher: 启动工具.command (for Finder)"
          ls -la release_console_universal | head -n 50

      - name: Build macOS .app wrapper (universal)
        shell: bash
        run: |
          set -euo pipefail
          
          # Paths
          CONSOLE_UNIVERSAL_DIR="release_console_universal"
          RELEASE_DIR="sunday-photos/release_mac_app_universal"
          APP_BUNDLE="$RELEASE_DIR/SundayPhotoOrganizer.app"
          
          # Validate universal launcher exists
          if [ ! -f "$CONSOLE_UNIVERSAL_DIR/SundayPhotoOrganizer" ]; then
            echo "Error: Universal launcher not found at $CONSOLE_UNIVERSAL_DIR/SundayPhotoOrganizer"
            ls -la "$CONSOLE_UNIVERSAL_DIR" || true
            exit 1
          fi
          
          # Create release_mac_app_universal structure
          rm -rf "$RELEASE_DIR"
          mkdir -p "$RELEASE_DIR"
          mkdir -p "$RELEASE_DIR/input/class_photos"
          mkdir -p "$RELEASE_DIR/input/student_photos"
          mkdir -p "$RELEASE_DIR/output"
          mkdir -p "$RELEASE_DIR/logs"
          
          # Copy config
          cp -f sunday-photos/config.json "$RELEASE_DIR/"
          
          # Create placeholder files
          echo "将课堂合照放在这里" > "$RELEASE_DIR/input/class_photos/PUT_CLASS_PHOTOS_HERE.txt"
          echo "将学生个人照放在这里" > "$RELEASE_DIR/input/student_photos/PUT_STUDENT_PHOTOS_HERE.txt"
          
          # Generate AppleScript that opens Terminal (teacher-friendly mode)
          OSASCRIPT_FILE="$(mktemp).applescript"
          cat > "$OSASCRIPT_FILE" <<'APPLESCRIPT'
          on run
            set appBundlePath to POSIX path of (path to me)
            set parentDir to do shell script "/usr/bin/dirname " & quoted form of appBundlePath
            set resourcesDir to appBundlePath & "Contents/Resources"
            set exePath to resourcesDir & "/SundayPhotoOrganizer"
            set mplConfigDir to parentDir & "/logs/mplconfig"
            set cmd to "cd " & quoted form of parentDir & " && /bin/mkdir -p " & quoted form of mplConfigDir & " && /usr/bin/clear && /usr/bin/env " & ¬
              "SUNDAY_PHOTOS_TEACHER_MODE=1 " & ¬
              "SUNDAY_PHOTOS_UI_PAUSE_MS=200 " & ¬
              "SUNDAY_PHOTOS_WORK_DIR=" & quoted form of parentDir & " " & ¬
              "MPLBACKEND=Agg " & ¬
              "MPLCONFIGDIR=" & quoted form of mplConfigDir & " " & ¬
              "OMP_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 MKL_NUM_THREADS=1 VECLIB_MAXIMUM_THREADS=1 " & ¬
              "SUNDAY_PHOTOS_PARALLEL_STRATEGY=threads " & ¬
              quoted form of exePath
          
            -- Best-effort: avoid opening another Terminal if already running.
            try
              set isRunning to do shell script "/usr/bin/pgrep -f '/SundayPhotoOrganizer$' >/dev/null 2>&1; echo $?"
              if isRunning is "0" then
                display dialog "程序已在运行，请查看已打开的终端窗口（不要重复双击）。" buttons {"好的"} default button 1
                return
              end if
            end try
          
            tell application "Terminal"
              activate
              do script cmd
            end tell
          end run
          APPLESCRIPT
          
          # Compile AppleScript into .app
          osacompile -o "$APP_BUNDLE" "$OSASCRIPT_FILE"
          rm -f "$OSASCRIPT_FILE"
          
          # Copy universal launcher into app bundle
          mkdir -p "$APP_BUNDLE/Contents/Resources"
          cp "$CONSOLE_UNIVERSAL_DIR/SundayPhotoOrganizer" "$APP_BUNDLE/Contents/Resources/"
          chmod +x "$APP_BUNDLE/Contents/Resources/SundayPhotoOrganizer"
          
          # Replace default applet icon with custom icon
          if [ -f sunday-photos/app_icon.iconset/icon_512x512.png ]; then
            # Generate .icns from iconset if needed
            ICON_ICNS="sunday-photos/app_icon.icns"
            if [ ! -f "$ICON_ICNS" ] || [ sunday-photos/app_icon.iconset -nt "$ICON_ICNS" ]; then
              iconutil -c icns -o "$ICON_ICNS" sunday-photos/app_icon.iconset 2>/dev/null || true
            fi
            
            if [ -f "$ICON_ICNS" ]; then
              cp -f "$ICON_ICNS" "$APP_BUNDLE/Contents/Resources/applet.icns"
              # Refresh icon cache
              touch "$APP_BUNDLE" "$APP_BUNDLE/Contents/Info.plist" "$APP_BUNDLE/Contents/Resources/applet.icns"
            fi
          fi
          
          # Copy teacher docs
          cp -f sunday-photos/doc/TeacherQuickStart.md "$RELEASE_DIR/老师快速开始.md"
          cp -f sunday-photos/doc/TeacherQuickStart_en.md "$RELEASE_DIR/QuickStart_EN.md"
          
          cat > "$RELEASE_DIR/使用说明_启动方式.md" <<'EOF'
          # macOS 启动方式（老师版 .app）
          
          1) 双击 `SundayPhotoOrganizer.app` 启动。
          2) 默认会自动打开"终端 Terminal"窗口显示运行进度（控制台信息）。
          
          如果 macOS 提示"无法打开/来自未知开发者"：
          - 右键点击 app → 打开 → 再次点击"打开"
          - 或：系统设置 → 隐私与安全性 → 找到被拦截的 app → 仍要打开
          EOF
          
          echo "✅ Universal .app created: $APP_BUNDLE"
          ls -la "$APP_BUNDLE/Contents/Resources" | head -n 20

      - name: Upload console bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal-console
          path: release_console_universal/
          retention-days: 7

      - name: Upload .app bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal-app
          path: sunday-photos/release_mac_app_universal/
          retention-days: 7
