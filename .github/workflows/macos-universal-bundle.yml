name: macOS universal bundle (arm64 + x86_64)

on:
  workflow_dispatch:

jobs:
  build_arm64:
    name: Build arm64
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          brew update
          brew install cmake
          cmake --version

      - name: Install dependencies
        working-directory: sunday-photos
        run: |
          export PATH="$(brew --prefix)/bin:$PATH"
          which cmake
          cmake --version

          python -m pip install --upgrade pip setuptools wheel
          python -m pip uninstall -y cmake || true

          # dlib is the riskiest dependency in CI; prefer wheels when available
          python -m pip install "dlib>=19.24.2" --only-binary :all: || python -m pip install "dlib>=19.24.2"
          python -m pip install --prefer-binary -r requirements.txt
          python -m pip install pyinstaller

      - name: Build (arm64)
        working-directory: sunday-photos
        env:
          TARGET_ARCH: arm64
        run: |
          bash scripts/build_mac_app.sh

      - name: Report packaged size (arm64 diagnostics)
        working-directory: sunday-photos
        shell: bash
        run: |
          set -euo pipefail
          echo "release_console size (arm64 build):"
          du -sh release_console || true
          echo "Top 20 largest files:"
          du -ah release_console | sort -hr | head -n 20 || true

      - name: Upload artifact (arm64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-release_console
          path: sunday-photos/release_console/

  build_x86_64:
    name: Build x86_64
    runs-on: macos-15-intel
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          brew update
          brew install cmake
          cmake --version

      - name: Install dependencies
        working-directory: sunday-photos
        run: |
          export PATH="$(brew --prefix)/bin:$PATH"
          which cmake
          cmake --version

          python -m pip install --upgrade pip setuptools wheel
          python -m pip uninstall -y cmake || true

          # dlib is the riskiest dependency in CI; prefer wheels when available
          python -m pip install "dlib>=19.24.2" --only-binary :all: || python -m pip install "dlib>=19.24.2"
          python -m pip install --prefer-binary -r requirements.txt
          python -m pip install pyinstaller

      - name: Build (x86_64)
        working-directory: sunday-photos
        env:
          TARGET_ARCH: x86_64
        run: |
          bash scripts/build_mac_app.sh

      - name: Report packaged size (x86_64 diagnostics)
        working-directory: sunday-photos
        shell: bash
        run: |
          set -euo pipefail
          echo "release_console size (x86_64 build):"
          du -sh release_console || true
          echo "Top 20 largest files:"
          du -ah release_console | sort -hr | head -n 20 || true

      - name: Upload artifact (x86_64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-release_console
          path: sunday-photos/release_console/

  bundle:
    name: Bundle universal package
    runs-on: macos-14
    needs: [build_arm64, build_x86_64]
    steps:
      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-release_console
          path: artifacts/arm64

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-x86_64-release_console
          path: artifacts/x86_64

      - name: Create universal release_console
        shell: bash
        run: |
          set -euo pipefail

          ARM_DIR="artifacts/arm64"
          X86_DIR="artifacts/x86_64"

          # PyInstaller may produce either:
          # - onefile: SundayPhotoOrganizer (file)
          # - onedir : SundayPhotoOrganizer/ (directory containing the executable)
          if [ ! -e "$ARM_DIR/SundayPhotoOrganizer" ]; then
            echo "arm64 payload not found: $ARM_DIR/SundayPhotoOrganizer" >&2
            ls -la "$ARM_DIR" || true
            exit 1
          fi
          if [ ! -e "$X86_DIR/SundayPhotoOrganizer" ]; then
            echo "x86_64 payload not found: $X86_DIR/SundayPhotoOrganizer" >&2
            ls -la "$X86_DIR" || true
            exit 1
          fi

          rm -rf release_console_universal
          cp -R "$ARM_DIR" release_console_universal

          mkdir -p release_console_universal/bin
          rm -rf release_console_universal/bin/SundayPhotoOrganizer-arm64 release_console_universal/bin/SundayPhotoOrganizer-x86_64

          # Move arm64 payload (file or directory) into bin/
          mv release_console_universal/SundayPhotoOrganizer release_console_universal/bin/SundayPhotoOrganizer-arm64

          # Copy x86_64 payload (file or directory) into bin/
          if [ -d "$X86_DIR/SundayPhotoOrganizer" ]; then
            cp -R "$X86_DIR/SundayPhotoOrganizer" release_console_universal/bin/SundayPhotoOrganizer-x86_64
          else
            cp "$X86_DIR/SundayPhotoOrganizer" release_console_universal/bin/SundayPhotoOrganizer-x86_64
          fi

          # Validate payloads
          if [ -d "release_console_universal/bin/SundayPhotoOrganizer-arm64" ]; then
            test -f "release_console_universal/bin/SundayPhotoOrganizer-arm64/SundayPhotoOrganizer"
          else
            test -f "release_console_universal/bin/SundayPhotoOrganizer-arm64"
          fi
          if [ -d "release_console_universal/bin/SundayPhotoOrganizer-x86_64" ]; then
            test -f "release_console_universal/bin/SundayPhotoOrganizer-x86_64/SundayPhotoOrganizer"
          else
            test -f "release_console_universal/bin/SundayPhotoOrganizer-x86_64"
          fi

          # Create main launcher script (for terminal use)
          cat > release_console_universal/SundayPhotoOrganizer <<'EOF'
          #!/bin/bash
          set -euo pipefail
          DIR="$(cd "$(dirname "$0")" && pwd)"
          ARCH="$(uname -m)"
          if [[ "$ARCH" == "arm64" ]]; then
            TARGET="$DIR/bin/SundayPhotoOrganizer-arm64"
          else
            TARGET="$DIR/bin/SundayPhotoOrganizer-x86_64"
          fi

          if [[ -d "$TARGET" ]]; then
            exec "$TARGET/SundayPhotoOrganizer" "$@"
          else
            exec "$TARGET" "$@"
          fi
          EOF
          chmod +x release_console_universal/SundayPhotoOrganizer

          # Create .command file for double-click launching on macOS
          cat > release_console_universal/启动工具.command <<'EOF'
          #!/bin/bash
          # macOS 双击启动脚本（.command 文件可在 Finder 中双击运行）
          set -euo pipefail
          
          # 切换到脚本所在目录
          cd "$(dirname "$0")"
          
          # 调用主启动器
          ./SundayPhotoOrganizer
          
          # 运行完成后暂停，让用户看到输出
          echo ""
          echo "按任意键退出..."
          read -n 1 -s
          EOF
          chmod +x release_console_universal/启动工具.command

          # Set executable permissions on actual binaries
          if [ -d release_console_universal/bin/SundayPhotoOrganizer-arm64 ]; then
            chmod +x release_console_universal/bin/SundayPhotoOrganizer-arm64/SundayPhotoOrganizer
          else
            chmod +x release_console_universal/bin/SundayPhotoOrganizer-arm64
          fi
          if [ -d release_console_universal/bin/SundayPhotoOrganizer-x86_64 ]; then
            chmod +x release_console_universal/bin/SundayPhotoOrganizer-x86_64/SundayPhotoOrganizer
          else
            chmod +x release_console_universal/bin/SundayPhotoOrganizer-x86_64
          fi

          echo "Universal package prepared: release_console_universal"
          echo "- Main launcher: SundayPhotoOrganizer (for terminal)"
          echo "- Double-click launcher: 启动工具.command (for Finder)"
          ls -la release_console_universal | head -n 50

      - name: Upload artifact (universal)
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: release_console_universal/
