name: macOS universal bundle (arm64 + x86_64)

on:
  workflow_dispatch:

jobs:
  build_arm64:
    name: Build arm64
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          brew update
          brew install cmake
          cmake --version

      - name: Install dependencies
        working-directory: sunday-photos
        run: |
          export PATH="$(brew --prefix)/bin:$PATH"
          which cmake
          cmake --version

          python -m pip install --upgrade pip setuptools wheel
          python -m pip uninstall -y cmake || true

          # dlib is the riskiest dependency in CI; prefer wheels when available
          python -m pip install "dlib>=19.24.2" --only-binary :all: || python -m pip install "dlib>=19.24.2"
          python -m pip install --prefer-binary -r requirements.txt
          python -m pip install pyinstaller

      - name: Build (arm64)
        working-directory: sunday-photos
        env:
          TARGET_ARCH: arm64
        run: |
          bash scripts/build_mac_app.sh

      - name: Report packaged size (arm64 diagnostics)
        working-directory: sunday-photos
        shell: bash
        run: |
          set -euo pipefail
          echo "release_console size (arm64 build):"
          du -sh release_console || true
          echo "Top 20 largest files:"
          du -ah release_console | sort -hr | head -n 20 || true

      - name: Upload artifact (arm64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-release_console
          path: sunday-photos/release_console/

  build_x86_64:
    name: Build x86_64
    runs-on: macos-15-intel
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          brew update
          brew install cmake
          cmake --version

      - name: Install dependencies
        working-directory: sunday-photos
        run: |
          export PATH="$(brew --prefix)/bin:$PATH"
          which cmake
          cmake --version

          python -m pip install --upgrade pip setuptools wheel
          python -m pip uninstall -y cmake || true

          # dlib is the riskiest dependency in CI; prefer wheels when available
          python -m pip install "dlib>=19.24.2" --only-binary :all: || python -m pip install "dlib>=19.24.2"
          python -m pip install --prefer-binary -r requirements.txt
          python -m pip install pyinstaller

      - name: Build (x86_64)
        working-directory: sunday-photos
        env:
          TARGET_ARCH: x86_64
        run: |
          bash scripts/build_mac_app.sh

      - name: Report packaged size (x86_64 diagnostics)
        working-directory: sunday-photos
        shell: bash
        run: |
          set -euo pipefail
          echo "release_console size (x86_64 build):"
          du -sh release_console || true
          echo "Top 20 largest files:"
          du -ah release_console | sort -hr | head -n 20 || true

      - name: Upload artifact (x86_64)
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-release_console
          path: sunday-photos/release_console/

  bundle:
    name: Bundle universal package
    runs-on: macos-14
    needs: [build_arm64, build_x86_64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-release_console
          path: artifacts/arm64

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-x86_64-release_console
          path: artifacts/x86_64

      - name: Create universal release_console
        shell: bash
        run: |
          set -euo pipefail

          ARM_DIR="artifacts/arm64"
          X86_DIR="artifacts/x86_64"

          # Validate onedir bundles exist (PyInstaller configured for onedir mode)
          if [ ! -d "$ARM_DIR/SundayPhotoOrganizer" ]; then
            echo "âŒ arm64 onedir bundle not found: $ARM_DIR/SundayPhotoOrganizer/" >&2
            echo "Expected: $ARM_DIR/SundayPhotoOrganizer/SundayPhotoOrganizer (executable)" >&2
            ls -la "$ARM_DIR" || true
            exit 1
          fi
          if [ ! -d "$X86_DIR/SundayPhotoOrganizer" ]; then
            echo "âŒ x86_64 onedir bundle not found: $X86_DIR/SundayPhotoOrganizer/" >&2
            echo "Expected: $X86_DIR/SundayPhotoOrganizer/SundayPhotoOrganizer (executable)" >&2
            ls -la "$X86_DIR" || true
            exit 1
          fi
          
          # Validate executables inside onedir bundles
          if [ ! -f "$ARM_DIR/SundayPhotoOrganizer/SundayPhotoOrganizer" ]; then
            echo "âŒ arm64 executable missing in onedir bundle" >&2
            ls -la "$ARM_DIR/SundayPhotoOrganizer" || true
            exit 1
          fi
          if [ ! -f "$X86_DIR/SundayPhotoOrganizer/SundayPhotoOrganizer" ]; then
            echo "âŒ x86_64 executable missing in onedir bundle" >&2
            ls -la "$X86_DIR/SundayPhotoOrganizer" || true
            exit 1
          fi

          # Create universal bundle structure
          rm -rf release_console_universal
          cp -R "$ARM_DIR" release_console_universal
          
          # Move architecture-specific onedir bundles into bin/
          mkdir -p release_console_universal/bin
          mv release_console_universal/SundayPhotoOrganizer release_console_universal/bin/SundayPhotoOrganizer-arm64
          cp -R "$X86_DIR/SundayPhotoOrganizer" release_console_universal/bin/SundayPhotoOrganizer-x86_64

          # Create universal launcher script
          cat > release_console_universal/SundayPhotoOrganizer <<'EOF'
          #!/bin/bash
          set -euo pipefail
          DIR="$(cd "$(dirname "$0")" && pwd)"
          ARCH="$(uname -m)"
          
          if [[ "$ARCH" == "arm64" ]]; then
            TARGET="$DIR/bin/SundayPhotoOrganizer-arm64"
          else
            TARGET="$DIR/bin/SundayPhotoOrganizer-x86_64"
          fi
          
          # Execute architecture-specific onedir bundle
          exec "$TARGET/SundayPhotoOrganizer" "$@"
          EOF
          chmod +x release_console_universal/SundayPhotoOrganizer

          # Create .command file for double-click launching on macOS
          cat > release_console_universal/å¯åŠ¨å·¥å…·.command <<'EOF'
          #!/bin/bash
          # macOS åŒå‡»å¯åŠ¨è„šæœ¬ï¼ˆ.command æ–‡ä»¶å¯åœ¨ Finder ä¸­åŒå‡»è¿è¡Œï¼‰
          set -euo pipefail
          
          # åˆ‡æ¢åˆ°è„šæœ¬æ‰€åœ¨ç›®å½•
          cd "$(dirname "$0")"
          
          # è°ƒç”¨ä¸»å¯åŠ¨å™¨
          ./SundayPhotoOrganizer
          
          # è¿è¡Œå®Œæˆåæš‚åœï¼Œè®©ç”¨æˆ·çœ‹åˆ°è¾“å‡º
          echo ""
          echo "æŒ‰ä»»æ„é”®é€€å‡º..."
          read -n 1 -s
          EOF
          chmod +x release_console_universal/å¯åŠ¨å·¥å…·.command

          # Set executable permissions on architecture-specific binaries
          chmod +x release_console_universal/bin/SundayPhotoOrganizer-arm64/SundayPhotoOrganizer
          chmod +x release_console_universal/bin/SundayPhotoOrganizer-x86_64/SundayPhotoOrganizer

          echo "âœ… Universal console package prepared: release_console_universal"
          echo "ğŸ“¦ Structure:"
          echo "  - SundayPhotoOrganizer (universal launcher script)"
          echo "  - å¯åŠ¨å·¥å…·.command (double-click launcher for Finder)"
          echo "  - bin/SundayPhotoOrganizer-arm64/ (onedir bundle)"
          echo "  - bin/SundayPhotoOrganizer-x86_64/ (onedir bundle)"
          ls -la release_console_universal | head -n 50

      - name: Build macOS .app wrapper (universal)
        shell: bash
        run: |
          set -euo pipefail
          
          # Paths
          CONSOLE_UNIVERSAL_DIR="release_console_universal"
          RELEASE_DIR="sunday-photos/release_mac_app_universal"
          APP_BUNDLE="$RELEASE_DIR/SundayPhotoOrganizer.app"
          
          # Validate universal launcher exists
          if [ ! -f "$CONSOLE_UNIVERSAL_DIR/SundayPhotoOrganizer" ]; then
            echo "Error: Universal launcher not found at $CONSOLE_UNIVERSAL_DIR/SundayPhotoOrganizer"
            ls -la "$CONSOLE_UNIVERSAL_DIR" || true
            exit 1
          fi
          
          # Create release_mac_app_universal structure
          rm -rf "$RELEASE_DIR"
          mkdir -p "$RELEASE_DIR"
          mkdir -p "$RELEASE_DIR/input/class_photos"
          mkdir -p "$RELEASE_DIR/input/student_photos"
          mkdir -p "$RELEASE_DIR/output"
          mkdir -p "$RELEASE_DIR/logs"
          
          # Copy config
          cp -f sunday-photos/config.json "$RELEASE_DIR/"
          
          # Create placeholder files
          echo "å°†è¯¾å ‚åˆç…§æ”¾åœ¨è¿™é‡Œ" > "$RELEASE_DIR/input/class_photos/PUT_CLASS_PHOTOS_HERE.txt"
          echo "å°†å­¦ç”Ÿä¸ªäººç…§æ”¾åœ¨è¿™é‡Œ" > "$RELEASE_DIR/input/student_photos/PUT_STUDENT_PHOTOS_HERE.txt"
          
          # Generate AppleScript that opens Terminal (teacher-friendly mode)
          OSASCRIPT_FILE="$(mktemp).applescript"
          cat > "$OSASCRIPT_FILE" <<'APPLESCRIPT'
          on run
            set appBundlePath to POSIX path of (path to me)
            set parentDir to do shell script "/usr/bin/dirname " & quoted form of appBundlePath
            set resourcesDir to appBundlePath & "/Contents/Resources"
            set exePath to resourcesDir & "/SundayPhotoOrganizer"
            set mplConfigDir to parentDir & "/logs/mplconfig"
            set cmd to "cd " & quoted form of parentDir & " && /bin/mkdir -p " & quoted form of mplConfigDir & " && /usr/bin/clear && /usr/bin/env " & Â¬
              "SUNDAY_PHOTOS_TEACHER_MODE=1 " & Â¬
              "SUNDAY_PHOTOS_UI_PAUSE_MS=200 " & Â¬
              "SUNDAY_PHOTOS_WORK_DIR=" & quoted form of parentDir & " " & Â¬
              "MPLBACKEND=Agg " & Â¬
              "MPLCONFIGDIR=" & quoted form of mplConfigDir & " " & Â¬
              "OMP_NUM_THREADS=1 OPENBLAS_NUM_THREADS=1 MKL_NUM_THREADS=1 VECLIB_MAXIMUM_THREADS=1 " & Â¬
              "SUNDAY_PHOTOS_PARALLEL_STRATEGY=threads " & Â¬
              quoted form of exePath
          
            -- Best-effort: avoid opening another Terminal if already running.
            try
              set isRunning to do shell script "/usr/bin/pgrep -f '/SundayPhotoOrganizer$' >/dev/null 2>&1; echo $?"
              if isRunning is "0" then
                display dialog "ç¨‹åºå·²åœ¨è¿è¡Œï¼Œè¯·æŸ¥çœ‹å·²æ‰“å¼€çš„ç»ˆç«¯çª—å£ï¼ˆä¸è¦é‡å¤åŒå‡»ï¼‰ã€‚" buttons {"å¥½çš„"} default button 1
                return
              end if
            end try
          
            tell application "Terminal"
              activate
              do script cmd
            end tell
          end run
          APPLESCRIPT
          
          # Compile AppleScript into .app
          osacompile -o "$APP_BUNDLE" "$OSASCRIPT_FILE"
          rm -f "$OSASCRIPT_FILE"
          
          # Copy universal launcher and bin directory into app bundle
          mkdir -p "$APP_BUNDLE/Contents/Resources"
          cp "$CONSOLE_UNIVERSAL_DIR/SundayPhotoOrganizer" "$APP_BUNDLE/Contents/Resources/"
          chmod +x "$APP_BUNDLE/Contents/Resources/SundayPhotoOrganizer"
          
          # Copy bin directory with architecture-specific onedir bundles
          cp -R "$CONSOLE_UNIVERSAL_DIR/bin" "$APP_BUNDLE/Contents/Resources/"
          
          # Set executable permissions on onedir binaries
          chmod +x "$APP_BUNDLE/Contents/Resources/bin/SundayPhotoOrganizer-arm64/SundayPhotoOrganizer"
          chmod +x "$APP_BUNDLE/Contents/Resources/bin/SundayPhotoOrganizer-x86_64/SundayPhotoOrganizer"
          
          # Replace default applet icon with custom icon
          if [ -f sunday-photos/app_icon.iconset/icon_512x512.png ]; then
            # Generate .icns from iconset if needed
            ICON_ICNS="sunday-photos/app_icon.icns"
            if [ ! -f "$ICON_ICNS" ] || [ sunday-photos/app_icon.iconset -nt "$ICON_ICNS" ]; then
              iconutil -c icns -o "$ICON_ICNS" sunday-photos/app_icon.iconset 2>/dev/null || true
            fi
            
            if [ -f "$ICON_ICNS" ]; then
              cp -f "$ICON_ICNS" "$APP_BUNDLE/Contents/Resources/applet.icns"
              # Refresh icon cache
              touch "$APP_BUNDLE" "$APP_BUNDLE/Contents/Info.plist" "$APP_BUNDLE/Contents/Resources/applet.icns"
            fi
          fi
          
          # Copy teacher docs
          cp -f sunday-photos/doc/TeacherQuickStart.md "$RELEASE_DIR/è€å¸ˆå¿«é€Ÿå¼€å§‹.md"
          cp -f sunday-photos/doc/TeacherQuickStart_en.md "$RELEASE_DIR/QuickStart_EN.md"
          
          cat > "$RELEASE_DIR/ä½¿ç”¨è¯´æ˜_å¯åŠ¨æ–¹å¼.md" <<'EOF'
          # macOS å¯åŠ¨æ–¹å¼ï¼ˆè€å¸ˆç‰ˆ .appï¼‰
          
          1) åŒå‡» `SundayPhotoOrganizer.app` å¯åŠ¨ã€‚
          2) é»˜è®¤ä¼šè‡ªåŠ¨æ‰“å¼€"ç»ˆç«¯ Terminal"çª—å£æ˜¾ç¤ºè¿è¡Œè¿›åº¦ï¼ˆæ§åˆ¶å°ä¿¡æ¯ï¼‰ã€‚
          
          å¦‚æœ macOS æç¤º"æ— æ³•æ‰“å¼€/æ¥è‡ªæœªçŸ¥å¼€å‘è€…"ï¼š
          - å³é”®ç‚¹å‡» app â†’ æ‰“å¼€ â†’ å†æ¬¡ç‚¹å‡»"æ‰“å¼€"
          - æˆ–ï¼šç³»ç»Ÿè®¾ç½® â†’ éšç§ä¸å®‰å…¨æ€§ â†’ æ‰¾åˆ°è¢«æ‹¦æˆªçš„ app â†’ ä»è¦æ‰“å¼€
          EOF
          
          echo "âœ… Universal .app created: $APP_BUNDLE"
          ls -la "$APP_BUNDLE/Contents/Resources" | head -n 20

      - name: Upload console bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal-console
          path: release_console_universal/
          retention-days: 7

      - name: Upload .app bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal-app
          path: sunday-photos/release_mac_app_universal/
          retention-days: 7
